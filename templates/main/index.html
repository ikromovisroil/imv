{% extends 'base.html' %}
{% load static %}

{% block title %}
    <title>document</title>
{% endblock title %}

{% block css %}
    <link
      rel="stylesheet"
      href="/charts/vanilla/pie-series/examples/simple-pie/ag-example-styles.css"/>
{% endblock css %}

{% block content %}
  <main id="main" class="main">

    <div class="pagetitle">
      <h1>Dashboard</h1>
    </div><!-- End Page Title -->

    <section class="section dashboard">
      <div class="row">

        <!-- Left side columns -->
        <div class="col-lg-8">
          <div class="row">
            {% for i in organizations1 %}
            <!-- Customers Card -->
            <div class="col-xxl-4 col-xl-12">

              <div class="card info-card customers-card">

                <div class="card-body">
                  <h5 class="card-title">{{i.name}}</h5>

                  <div class="d-flex align-items-center">
                    <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                      <i class="bi bi-people"></i>
                    </div>
                    <div class="ps-3">
                      <h6>{{i.technics_count}} - ta texnika</h6>
                    </div>
                  </div>

                </div>
              </div>

            </div><!-- End Customers Card -->
            {% endfor %}
            <!-- Reports -->
            <div class="col-12">
              <div class="card">

                <div id="chartArea"></div>

              </div>
            </div><!-- End Reports -->

          </div>
        </div><!-- End Left side columns -->

        <!-- Right side columns -->
        <div class="col-lg-4">

          <!-- Recent Activity -->
          <div class="card">
              <div class="card-body">
                <h5 class="card-title">Oxirgi harakatlar</h5>

                <div class="activity">
                  {% for i in activityLog %}
                    <div class="activity-item d-flex">
                      <div class="activite-label">
                        {{ i.timestamp|timesince }} oldin
                      </div>

                      {# Log turi bo‘yicha rang tanlash (create/update/delete) #}
                      {% if i.action == 'create' %}
                        <i class="bi bi-circle-fill activity-badge text-success align-self-start"></i>
                      {% elif i.action == 'update' %}
                        <i class="bi bi-circle-fill activity-badge text-primary align-self-start"></i>
                      {% elif i.action == 'delete' %}
                        <i class="bi bi-circle-fill activity-badge text-danger align-self-start"></i>
                      {% else %}
                        <i class="bi bi-circle-fill activity-badge text-muted align-self-start"></i>
                      {% endif %}

                      <div class="activity-content">
                        {% if i.user %}
                          <strong>{{ i.user.username }}</strong> —
                        {% endif %}
                        {{ i.get_action_display }}:
                        <span class="fw-bold">{{ i.model_name }}</span>
                        {% if i.object_name %} ({{ i.object_name }}){% endif %}

                        {% if i.description %}
                          <br><small class="text-muted">{{ i.description }}</small>
                        {% endif %}
                      </div>
                    </div><!-- End activity item-->
                  {% empty %}
                    <p class="text-muted">Hozircha faoliyat loglari yo‘q.</p>
                  {% endfor %}
                </div>

              </div>
            </div><!-- End Recent Activity -->


          <!-- Website Traffic -->
          <div class="card">
           <div id="chartPie"></div>
          </div><!-- End Website Traffic -->

        </div><!-- End Right side columns -->

      </div>
    </section>

  </main><!-- End #main -->
<script src="https://cdn.jsdelivr.net/npm/ag-charts-community@12.3.1/dist/umd/ag-charts-community.js"></script>

<script>
const { AgCharts } = agCharts;

/* =============================
   1) AREA CHART — kategoriya bo‘yicha texnika soni
   ============================= */
const areaOptions = {
    container: document.getElementById("chartArea"),
    title: {
        text: "Kategoriyalar bo‘yicha texnika soni",
    },
    data: JSON.parse('{{ chart_data|escapejs }}'),
    series: [
        {% for org in organizations %}
        {
            type: "area",
            xKey: "category",
            yKey: "org_{{ org.id }}",
            yName: "{{ org.name|escapejs }}",
            stacked: true,
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    axes: [
        { type: "category", position: "bottom", title: { text: "Kategoriyalar" }},
        { type: "number", position: "left", title: { text: "Soni" }},
    ],
    legend: { position: "top" },
};

AgCharts.create(areaOptions);


/* =============================
   2) PIE CHART — tashkilotlar bo‘yicha ulush
   ============================= */

// Masalan: har bir tashkilotning umumiy texnika soni (viewda hisoblab yuborasiz)
const pieData = JSON.parse('{{ pie_data|escapejs }}');

const pieOptions = {
    container: document.getElementById("chartPie"),
    title: {
        text: "Tashkilotlar ulushi",
    },
    data: pieData,   // [{ name: "IMV", count: 60 }, ...]
    series: [
        {
            type: "pie",
            angleKey: "count",
            labelKey: "name",
            innerRadiusRatio: 0.4,
            calloutLabelKey: "name",
            sectorLabelKey: "count",
            sectorLabel: {
                renderer: ({ datum }) => `${datum.count}`
            }
        }
    ],
    legend: { position: "bottom" }
};

AgCharts.create(pieOptions);
</script>


{% endblock content %}

{% block js %}
{% endblock js %}